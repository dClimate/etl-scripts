name: chirps-availability-check

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */3 * * *"

permissions:
  contents: read

jobs:
  load_and_plot:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install IPFS
        uses: ibnesayeed/setup-ipfs@c779340c110024feeb46579fef211c89332caf85
        with:
          ipfs_version: ${{vars.IPFS_VERSION}}

      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Install all dependencies
        run: uv sync

      - name: Load xarray Datasets and plot random timepoint for each
        run: |
          export IPFS_PATH=$(uv run temp-kubo.py create)
          ipfs daemon &
          sleep 5 # wait for ipfs daemon to finish starting up

          CATALOG_CID=$(ipfs name resolve /ipns/k51qzi5uqu5dk89atnl883sr0g1cb2py631ckz9ng45qhk6dg0pj141jtxtx6l | awk -F'/' '{print $3}')
          GATEWAY_PORT=$(uv run temp-kubo.py port gateway $IPFS_PATH)
          RPC_PORT=$(uv run temp-kubo.py port rpc $IPFS_PATH)

          CHIRPS_FINAL_P05_CID=$(uv run stac.py collect hamt-root --search chirps-final-p05 $CATALOG_CID --rpc-uri-stem "http://127.0.0.1:$RPC_PORT" --gateway-uri-stem "http://127.0.0.1:$GATEWAY_PORT")
          CHIRPS_FINAL_P25_CID=$(uv run stac.py collect hamt-root --search chirps-final-p25 $CATALOG_CID --rpc-uri-stem "http://127.0.0.1:$RPC_PORT" --gateway-uri-stem "http://127.0.0.1:$GATEWAY_PORT")
          CHIRPS_PRELIM_P05_CID=$(uv run stac.py collect hamt-root --search chirps-prelim-p05 $CATALOG_CID --rpc-uri-stem "http://127.0.0.1:$RPC_PORT" --gateway-uri-stem "http://127.0.0.1:$GATEWAY_PORT")

          uv run plot-random-timepoint.py $CHIRPS_FINAL_P05_CID /tmp
          uv run plot-random-timepoint.py $CHIRPS_FINAL_P25_CID /tmp
          uv run plot-random-timepoint.py $CHIRPS_PRELIM_P05_CID /tmp

      - uses: actions/upload-artifact@v4
        with:
          name: Plots
          path: /tmp/plot-*.png
          if-no-files-found: error
          compression-level: 0
